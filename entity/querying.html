<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Document</title>
   <link rel="stylesheet" href="../css/bootstrap.min.css">
   <link rel="stylesheet" href="../css/prism.css">
   <link rel="stylesheet" href="../css/style.css">
</head>
<body>
   <header>
      <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
         <div class="container">
            <a class="navbar-brand" href="../index.html">DevNet</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
               <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                  <li class="nav-item">
                     <a class="nav-link" aria-current="page" href="../index.html">Home</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link active" aria-current="page" href="../index.html">Documentation</a>
                  </li>
               </ul>
               <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                  <li class="nav-item dropdown">
                     <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Versions
                     </a>
                     <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="#">v1.0.0</a></li>
                     </ul>
                  </li>
               </ul>
            </div>
         </div>
      </nav>
   </header>
   <main role="main" class="pb-3 bg-white">
      <br>
      <div class="container">
         <div class="row">
            <aside style="width: 260px;">
               <nav id="accordion">
                  <a href="#" class="menu collapsed" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne"><span class="arrow"></span>CLI</a>
                  <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-bs-parent="#accordion">
                     <ul class="sub-menu">
                        <li><a class="nav-link text-dark" href="../cli/overview.html">Overview</a></li>
                        <li><a class="nav-link text-dark" href="../cli/start.html">Get Started</a></li>
                        <li><a class="nav-link text-dark" href="../cli/console.html">Console application</a></li>
                     </ul>
                  </div>
                  <a href="#" class="menu collapsed" data-bs-toggle="collapse" data-bs-target="#collapseSix" aria-expanded="false" aria-controls="collapseSix"><span class="arrow"></span>Fundamentals</a>
                  <div id="collapseSix" class="collapse" aria-labelledby="headingSix" data-bs-parent="#accordion">
                     <ul class="sub-menu">
                        <li><a class="nav-link text-dark" href="../fundamentals/overview.html">Overview</a></li>
                        <li><a class="nav-link text-dark" href="#">Generic Collections</a></li>
                        <li><a class="nav-link text-dark" href="#">Event Delegat</a></li>
                        <li><a class="nav-link text-dark" href="#">Async Tasks</a></li>
                        <li><a class="nav-link text-dark" href="#">Extension Method</a></li>
                        <li><a class="nav-link text-dark" href="#">Linq data query</a></li>
                        <li><a class="nav-link text-dark" href="#">Database Access Object</a></li>
                     </ul>
                  </div>
                  <a href="#" class="menu collapsed" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo"><span class="arrow"></span>Core</a>
                  <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-bs-parent="#accordion">
                     <ul class="sub-menu">
                        <li><a class="nav-link text-dark" href="../core/overview.html">Overview</a></li>
                        <li><a class="nav-link text-dark" href="../core/start.html">Get Started</a></li>
                        <li><a class="nav-link text-dark" href="../core/middleware.html">Middleware</a></li>
                        <li><a class="nav-link text-dark" href="../core/routing.html">Routing</a></li>
                        <li><a class="nav-link text-dark" href="../core/dependency.html">Dependency injection</a></li>
                        <li><a class="nav-link text-dark" href="../core/exception.html">Error Handling</a></li>
                        <li><a class="nav-link text-dark" href="#">Http message</a></li>
                        <li><a class="nav-link text-dark" href="#">Security</a></li>
                     </ul>
                  </div>
                  <a href="#" class="menu collapsed" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree"><span class="arrow"></span>MVC</a>
                  <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-bs-parent="#accordion">
                     <ul class="sub-menu">
                        <li><a class="nav-link text-dark" href="../mvc/overview.html">Overview</a></li>
                        <li><a class="nav-link text-dark" href="../mvc/start.html">Get Started</a></li>
                        <li><a class="nav-link text-dark" href="../mvc/controller.html">Controller</a></li>
                        <li><a class="nav-link text-dark" href="../mvc/view.html">View</a></li>
                        <li><a class="nav-link text-dark" href="../mvc/layout.html">Layout</a></li>
                        <li><a class="nav-link text-dark" href="../mvc/filters.html">Filters</a></li>
                     </ul>
                  </div>
                  <a href="" class="menu" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour"><span class="arrow"></span>Entity ORM</a>
                  <div id="collapseFour" class="collapse show" aria-labelledby="headingFour" data-bs-parent="#accordion">
                     <ul class="sub-menu">
                        <li><a class="nav-link text-dark" href="overview.html">Overview</a></li>
                        <li><a class="nav-link text-dark" href="model.html">Model</a></li>
                        <li><a class="nav-link text-dark fw-bold" href="querying.html">Querying Data</a></li>
                        <li><a class="nav-link text-dark" href="saving.html#4">Saving Data</a></li>
                        <li><a class="nav-link text-dark" href="relationships.html">Relationships</a></li>
                     </ul>
                  </div>
                  <a href="#" class="menu collapsed" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive"><span class="arrow"></span>Identity Manager</a>
                  <div id="collapseFive" class="collapse" aria-labelledby="headingFive" data-bs-parent="#accordion">
                     <ul class="sub-menu">
                        <li><a class="nav-link text-dark" href="../identity/overview.html">Overview</a></li>
                        <li><a class="nav-link text-dark" href="../identity/data.html">User Data</a></li>
                        <li><a class="nav-link text-dark" href="../identity/authentication.html">User Authentication</a></li>
                        <li><a class="nav-link text-dark" href="../identity/roles.html">User Roles</a></li>
                     </ul>
                  </div>
               </nav>
            </aside>
            <article class="flex-grow-1" style="width: 400px;">
               <h1>Querying Data</h1>
               <hr>
               <p>
                  The EntitySet property of EntityContext represents a collection of all entities of particular entity type, and can be used to query a single entity or multiple entities.
               </p>
               <h3>Loading All Entities</h3>
               <p>
                  The EntitySet is an iterable collection, so you can load all entities by iterating EntitySet instance using <code>foreach</code> as shown in the following example:
               </p>
               <pre><code class="language-php">
                  &lt;?php

                  namespace Application\Controllers;

                  use DevNet\Core\Controller\AbstractController;
                  use DevNet\Core\Controller\IActionResult;
                  use DevNet\Entity\EntityContext;

                  class HelloController extends AbstractController
                  {
                     private EntityContext $DbManager;

                     public function __construct(EntityContext $dbManager)
                     {
                        $this->DbManager = $dbManager;
                     }

                     public function all() : IActionResult
                     {
                        $students = $this->DbManager->Students;
                        $listNames = "";

                        foreach ($students as $student)
                        {
                           $listNames .= $student->Name .PHP_EOL;
                        }

                        return $this->content($listNames);
                     }
                  }
               </code></pre>
               <p>
                  If you want to passe all the entities to the view, it's not recommended to passe EntitySet repository to the view, it's better to convert it to an array using to method <code>toArray()</code> like in the example below.
               </p>
               <pre><code class="language-php">
                     public function all() : IActionResult
                     {
                        $this->ViewData["Students"] = $this->DbManager->Students->toArray();

                        return $this->view();
                     }
                  }
               </code></pre>
               <h3>Loading a single entity</h3>
               <p>
                  To load a single particular entity, use the method <code>EntitySet::find(int $id)</code> of <code>EntitySet</code> property to select an entity by its Id, like the following example:
               </p>
               <pre><code class="language-php">
                  public function profile($id) : IActionResult
                  {
                     $students = $this->DbManager->Students;
                     $student = $students->find($id);
                     
                     $profile = "name: {$student->Name}\n";
                     $profile .= "Age: {$student->Age}";

                     return $this->content($profile);
                  }
               </code></pre>
               <p>
                  Otherwise you can use the method <code>EntitySet::first()</code> to load to first entity of the record, or use the <code>EntitySet::last()</code> method to load the last one.
               </p>
               <pre><code class="language-php">
                  public function profile($id) : IActionResult
                  {
                     $students = $this->DbManager->Students;
                     $firstStudent = $students->first();
                     $lastStudent = $students->last();
                     
                     $report = "The first student is in the list: {$firstStudent->Name}\n";
                     $report .= "The last student in the list is: {$lastStudent->Name}";

                     return $this->content($report);
                  }
               </code></pre>
               <h3>Linq Query</h3>
               <p>
                  <code>EntitySet</code> implements <code>IQueryable</code> interface so it can use LINQ (Language-Integrated Query) to query data from the database, which allows you to use programing language to write strongly typed queries, by passing a representation of the LINQ query to the database provider in form of lambda expressions (closure function, arrow function) which can be muti functions chained together, and Database provider in turn translate it to database-specific query language (sqlite, mysql, ...) and return a data.
               </p>
               <p>
                  Linq methods are extension methods so in order to use this feature you have to define the extension namespace <code>DevNet\System\Linq;</code> using the key word <code>use</code> in every class, or code use Linq methods on instance of <code>EntitySet</code>. <br>
               </p>
               <blockquote>
                  <p>
                     <b>Note:</b> Queries are always executed against the database even if the entities returned in the result already exist in the tracker.
                  </p>
               </blockquote>
               <h5>Filtering Data</h5>
               <p>
                  Use the extension method <code>EntitySet::Where(closure $predecate)</code> to filter the data. <br>
                  The following code is equivalent to: <br>
                  <code>"SELECT * FROM Student WHERE Name = 'Alice' AND Age > 16"</code>
               </p>
               <pre><code class="language-php">
                  &lt;?php

                  namespace Application\Controllers;

                  use DevNet\Core\Controller\AbstractController;
                  use DevNet\Core\Controller\IActionResult;
                  use DevNet\Entity\EntityContext;
                  use DevNet\Entity\IEntity;
                  use DevNet\System\Linq;

                  class HelloController extends AbstractController
                  {
                     private EntityContext $DbManager;

                     public function __construct(EntityContext $dbManager)
                     {
                        $this->DbManager = $dbManager;
                     }

                     public function filter() : IEntity
                     {
                        $students = $this->DbManager->Students
                        return $this->students->where(fn($s) => $s->Name == "Alice" && $s->Age > 16)->first();
                     }
                  }
               </code></pre>
               <h5>Ordering Data</h5>
               <p>
                  The following code is equivalent to: <br>
                  <code>"SELECT * FROM Student ORDER BY Name, Age"</code>
               </p>
               <pre><code class="language-php">
                  public function order() : array
                  {
                     $students = $this->DbManager->Students
                     return $students->orderBy(fn($s) => $s->Name)->thenBy((fn($s) => $s->Age)->toArray();
                  }
               </code></pre>
               <h5>Reverse Ordering Data</h5>
               <p>
                  You can use the methods <code>orderByDescending</code> and <code>thenByDescending</code> for reverse ordoring like in the The following code, which is equivalent to: <br>
                  <code>"SELECT * FROM Student ORDER BY Name DESC, Age DESC"</code>
               </p>
               <pre><code class="language-php">
                  public function order() : array
                  {
                     $students = $this->DbManager->Students
                     return $students->orderByDescending(fn($s) => $s->Name)
                                     ->thenByDescending((fn($s) => $s->Age)
                                     ->toArray();
                  }
               </code></pre>
               <h5>Limiting Data</h5>
               <p>
                  The following code is equivalent to: <br>
                  <code>"SELECT * FROM Student LIMIT 5,10"</code>
               </p>
               <pre><code class="language-php">
                  public function limit() : array
                  {
                     $students = $this->DbManager->Students
                     return $students->skip(5)->take(10)->toArray();
                  }
               </code></pre>
               <h6>Pagination Example</h6>
               <p>
                  The following example code shows how to create a pagination with the help of <code>skip</code> and <code>take</code> Linq methods, assuming we wante to display <b>10</b> posts per page for the following route pattern : <code>"blog/page/{number}"</code>
               </p>
               <pre><code class="language-php">
                  public function page(int $number) : IActionResult
                  {
                     $limit  = 10;
                     $offset = ($number - 1) * $limit;
                     $posts = $this->DbManager->Posts
                     $this->ViewData["Posts"] = $posts->skip($offset)->take($limit)->toArray();
                     return $this->view("Blog/index");
                  }
               </code></pre>
               <p>
                  For page number 1 will display the first 10 posts, for the page number 2 will skip the first 10 posts and display the next 10 posts, and for page number 3 will skip 20 posts and display the next 10 posts, and so on...
               </p>
               <h5>Complex Query</h5>
               <p>
                  Sometimes a simple query is not enough to solve a complex problem, so you can combine two or more clauses together to reache what you need as shown in the The following code, which is equivalent to: <br>
                  <code>"SELECT * FROM Student WHERE Age > 16 ORDER BY Name LIMIT 10"</code>
               </p>
               <pre><code class="language-php">
                  public function resolve() : array
                  {
                     $students = $this->DbManager->Students
                     return $students->where(fn($s) => $s->Age > 16)
                                     ->orderBy(fn($s) => $s->Name)
                                     ->take(10)
                                     ->toArray();
                  }
               </code></pre>
               <footer>
                  <nav class="no-print" aria-label="Page navigation">
                     <ul class="nav-page">
                        <li class="nav-page-item">
                           <a class="nav-page-link" href="model.html">
                              <i class="chevron left"></i> Previous
                           </a>
                        </li>
                        <li class="nav-page-item">
                           <a class="nav-page-link" href="saving.html">
                              Next <i class="chevron right"></i>
                           </a>
                        </li>
                     </ul>
                  </nav>
               </footer>
            </article>
         </div>
      </div>
   </main>
   <footer class="border-top footer text-muted bg-white">
      <div class="container">
         © 2020 - DevNet by Mohammed Moussaoui.
      </div>
   </footer>
   <script src="../js/bootstrap.bundle.min.js"></script>
   <script src="../js/prism.js"></script>
</body>
</html>